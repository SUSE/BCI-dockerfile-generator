<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Adding and Modifying Container Images &#8212; bci-build-templates  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Creating packages on OBS" href="creating_packages.html" />
    <link rel="prev" title="BCI build recipe generator" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="adding-and-modifying-container-images">
<span id="id1"></span><h1>Adding and Modifying Container Images<a class="headerlink" href="#adding-and-modifying-container-images" title="Permalink to this heading">¶</a></h1>
<p>All container images are defined in <code class="file docutils literal notranslate"><span class="pre">src/bci_build/package.py</span></code> as
instances of the <a class="reference internal" href="api.html#bci_build.package.LanguageStackContainer" title="bci_build.package.LanguageStackContainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">LanguageStackContainer</span></code></a>,
<a class="reference internal" href="api.html#bci_build.package.ApplicationStackContainer" title="bci_build.package.ApplicationStackContainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">ApplicationStackContainer</span></code></a> or
<a class="reference internal" href="api.html#bci_build.package.OsContainer" title="bci_build.package.OsContainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">OsContainer</span></code></a> classes.</p>
<p>The different classes result in slightly different images, mostly with respect
to the way versions, tags and labels are handled. For example instances of
<a class="reference internal" href="api.html#bci_build.package.ApplicationStackContainer" title="bci_build.package.ApplicationStackContainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">ApplicationStackContainer</span></code></a> will receive the label
<code class="docutils literal notranslate"><span class="pre">com.suse.image-type=&quot;application&quot;</span></code>, whereas all others will have
<code class="docutils literal notranslate"><span class="pre">com.suse.image-type=&quot;sle-bci&quot;</span></code>.</p>
<p>To create a new container image, pick the most fitting class for it and create
an instance of it supplying the following values:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.name" title="bci_build.package.BaseContainerImage.name"><code class="xref py py-attr docutils literal notranslate"><span class="pre">name</span></code></a>: This is a short
identifier of your image and is used to generate the name of this image on the
registry as well as the prefixlabel. Pick something short and descriptive,
e.g. <code class="docutils literal notranslate"><span class="pre">node</span></code> for a Node.js container image.</p></li>
<li><p><a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.pretty_name" title="bci_build.package.BaseContainerImage.pretty_name"><code class="xref py py-attr docutils literal notranslate"><span class="pre">pretty_name</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.package_name" title="bci_build.package.BaseContainerImage.package_name"><code class="xref py py-attr docutils literal notranslate"><span class="pre">package_name</span></code></a>: The name of the
package on build.opensuse.org in <code class="docutils literal notranslate"><span class="pre">devel:BCI:SLE-15-SP${os_version}</span></code> that is
used to build this container image. This value is not autogenerated, as we
were inconsistent in the past, but this value should default to
<a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.uid" title="bci_build.package.BaseContainerImage.uid"><code class="xref py py-attr docutils literal notranslate"><span class="pre">uid</span></code></a> <code class="docutils literal notranslate"><span class="pre">-image</span></code>.</p></li>
<li><p><a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.os_version" title="bci_build.package.BaseContainerImage.os_version"><code class="xref py py-attr docutils literal notranslate"><span class="pre">os_version</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.release_stage" title="bci_build.package.BaseContainerImage.release_stage"><code class="xref py py-attr docutils literal notranslate"><span class="pre">release_stage</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.package_list" title="bci_build.package.BaseContainerImage.package_list"><code class="xref py py-attr docutils literal notranslate"><span class="pre">package_list</span></code></a>: The list of
packages to be installed into the container image.
You can either provide a list of strings here or provide a list of
<a class="reference internal" href="api.html#bci_build.package.Package" title="bci_build.package.Package"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Package</span></code></a> class instances. The latter is only
necessary if you want to build your container image with kiwi and wish to
customize the package installation (or deletion) process. See <a class="reference internal" href="#installing-packages-into-the-container-image">Installing
Packages into the Container Image</a> for further details.</p></li>
</ul>
<section id="adding-files-to-the-image">
<h2>Adding files to the Image<a class="headerlink" href="#adding-files-to-the-image" title="Permalink to this heading">¶</a></h2>
<p>The package on build.opensuse.org will by default only consist of the following
files:</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code> or <code class="file docutils literal notranslate"><span class="pre">$</span><em><span class="pre">pkg_name</span></em><span class="pre">.kiwi</span></code> and optionally a <code class="file docutils literal notranslate"><span class="pre">config.sh</span></code></p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">$</span><em><span class="pre">pkg_name</span></em><span class="pre">.changes</span></code></p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">_service</span></code></p></li>
</ul>
<p>It is sometimes necessary to include additional files in a Container Image,
e.g. a longer script or configuration file. This can be achieved by adding the
file to the <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.extra_files" title="bci_build.package.BaseContainerImage.extra_files"><code class="xref py py-attr docutils literal notranslate"><span class="pre">extra_files</span></code></a>
dictionary. The key should be the file name and the value are the file contents.</p>
<p>Please only include very short files directly in
<code class="file docutils literal notranslate"><span class="pre">src/bci_build/package.py</span></code>. Longer files should go into a subdirectory of
<code class="file docutils literal notranslate"><span class="pre">src/bci_build</span></code> and be read in on construction. In case you are taking the
additional file from an upstream source, then consider adding it to the script
<code class="file docutils literal notranslate"><span class="pre">update-files.sh</span></code> as well. A Github Action runs this script every day and
ensures that your external file stays up to date.</p>
</section>
<section id="automatic-package-version-substitution">
<h2>Automatic Package Version Substitution<a class="headerlink" href="#automatic-package-version-substitution" title="Permalink to this heading">¶</a></h2>
<p>Some Container Images ship with environment variables that include the version
of a component in the container image. For example the PostgreSQL Container
Image sets the environment variable <code class="docutils literal notranslate"><span class="pre">PG_VERSION</span></code> to the <cite>major.minor</cite> version
of PostgreSQL installed in the container image.</p>
<p>Setting this environment variable manually is rather brittle and would require
to constantly update the sources. Instead, we can leverage the service
<a class="reference external" href="https://github.com/openSUSE/obs-service-replace_using_package_version">obs-service-replace_using_package_version</a>.</p>
<p>The <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage" title="bci_build.package.BaseContainerImage"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseContainerImage</span></code></a> has builtin support for
this service via the attribute
<a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.replacements_via_service" title="bci_build.package.BaseContainerImage.replacements_via_service"><code class="xref py py-attr docutils literal notranslate"><span class="pre">replacements_via_service</span></code></a>. To
use it in your container image, pick a replacement string that is unique for
your whole build description. For the PostgreSQL version we could for instance
pick <code class="docutils literal notranslate"><span class="pre">%%pg_version%%</span></code>. Then an instance of
<a class="reference internal" href="api.html#bci_build.package.Replacement" title="bci_build.package.Replacement"><code class="xref py py-class docutils literal notranslate"><span class="pre">Replacement</span></code></a> needs to be added to the list
<a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.replacements_via_service" title="bci_build.package.BaseContainerImage.replacements_via_service"><code class="xref py py-attr docutils literal notranslate"><span class="pre">replacements_via_service</span></code></a>, where
the attribute
<a class="reference internal" href="api.html#bci_build.package.Replacement.regex_in_build_description" title="bci_build.package.Replacement.regex_in_build_description"><code class="xref py py-attr docutils literal notranslate"><span class="pre">regex_in_build_description</span></code></a> is set to
the replacement string. Additionally the attribute
<a class="reference internal" href="api.html#bci_build.package.Replacement.package_name" title="bci_build.package.Replacement.package_name"><code class="xref py py-attr docutils literal notranslate"><span class="pre">package_name</span></code></a> has to be set to the
<strong>exact</strong> name of the package which version we wish to extract. If only a part
of the version is required, e.g. as with <code class="docutils literal notranslate"><span class="pre">PG_VERSION</span></code> where we only care about
the major and minor version, but not the patch level, we can instruct the
service to only extract the version up to a certain point via the attribute
<a class="reference internal" href="api.html#bci_build.package.Replacement.parse_version" title="bci_build.package.Replacement.parse_version"><code class="xref py py-attr docutils literal notranslate"><span class="pre">parse_version</span></code></a>.</p>
<p>Our PostgreSQL example would result in the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ApplicationStackContainer</span><span class="p">(</span>
    <span class="n">additional_versions</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;%%pg_version%%&quot;</span><span class="p">],</span>
    <span class="n">env</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;PG_VERSION&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;%%pg_version%%&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">replacements_via_service</span><span class="o">=</span><span class="p">[</span>
        <span class="n">Replacement</span><span class="p">(</span>
            <span class="n">regex_in_build_description</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%%</span><span class="s2">pg_version</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">package_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;postgresql14-server&quot;</span><span class="p">,</span>
            <span class="n">parse_version</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="c1"># rest follows here</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that this process is <strong>not</strong> limited to environment variable, it can be
used to replace <strong>anything</strong> inside the container build description. This can be
seen in the above code block, where we also set the
<a class="reference internal" href="api.html#bci_build.package.LanguageStackContainer.additional_versions" title="bci_build.package.LanguageStackContainer.additional_versions"><code class="xref py py-attr docutils literal notranslate"><span class="pre">additional_versions</span></code></a>
attribute via this mechanism.</p>
</section>
<section id="installing-packages-into-the-container-image">
<h2>Installing Packages into the Container Image<a class="headerlink" href="#installing-packages-into-the-container-image" title="Permalink to this heading">¶</a></h2>
<p>In most cases it sufficient to just set the
<a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.package_list" title="bci_build.package.BaseContainerImage.package_list"><code class="xref py py-attr docutils literal notranslate"><span class="pre">package_list</span></code></a> attribute to a
list of package names as strings. This will yield a <code class="docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">zypper</span> <span class="pre">-n</span> <span class="pre">in</span>
<span class="pre">$list_of_packages</span></code> line in the <code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code> or the following XML in the
kiwi build description:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;packages</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;image&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- one line per package --&gt;</span>
<span class="w">  </span><span class="nt">&lt;package</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;$pkg_name&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/packages&gt;</span>
</pre></div>
</div>
<p>Kiwi supports additional package types to e.g. explicitly delete packages or
add them to the bootstrap image. Please see
<a class="reference external" href="https://osinside.github.io/kiwi/concept_and_workflow/packages.html">https://osinside.github.io/kiwi/concept_and_workflow/packages.html</a> for
further details.</p>
<p>To add packages of a different type than <code class="docutils literal notranslate"><span class="pre">image</span></code> requires to use instances of
<a class="reference internal" href="api.html#bci_build.package.Package" title="bci_build.package.Package"><code class="xref py py-class docutils literal notranslate"><span class="pre">Package</span></code></a> with the
<a class="reference internal" href="api.html#bci_build.package.Package.pkg_type" title="bci_build.package.Package.pkg_type"><code class="xref py py-attr docutils literal notranslate"><span class="pre">pkg_type</span></code></a> set to the appropriate value. For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">package_list</span><span class="o">=</span><span class="p">[</span>
    <span class="n">Package</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pkg_type</span><span class="o">=</span><span class="n">PackageType</span><span class="o">.</span><span class="n">BOOTSTRAP</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;bash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ca-certificates-mozilla-prebuilt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;distribution-release&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="applying-additional-changes-to-your-image">
<h2>Applying additional changes to your Image<a class="headerlink" href="#applying-additional-changes-to-your-image" title="Permalink to this heading">¶</a></h2>
<p>Container Images can be tweaked extensively via a plethora of different keywords
in <code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code>. To stay compatible with kiwi build descriptions and to
avoid some common pitfalls when creating a <code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code>.</p>
<p>For the following <code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code> settings, use the respective properties of
<a class="reference internal" href="api.html#bci_build.package.BaseContainerImage" title="bci_build.package.BaseContainerImage"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseContainerImage</span></code></a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.entrypoint" title="bci_build.package.BaseContainerImage.entrypoint"><code class="xref py py-attr docutils literal notranslate"><span class="pre">entrypoint</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CMD</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.cmd" title="bci_build.package.BaseContainerImage.cmd"><code class="xref py py-attr docutils literal notranslate"><span class="pre">cmd</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VOLUME</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.volumes" title="bci_build.package.BaseContainerImage.volumes"><code class="xref py py-attr docutils literal notranslate"><span class="pre">volumes</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXPOSE</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.exposes_tcp" title="bci_build.package.BaseContainerImage.exposes_tcp"><code class="xref py py-attr docutils literal notranslate"><span class="pre">exposes_tcp</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ENV</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.env" title="bci_build.package.BaseContainerImage.env"><code class="xref py py-attr docutils literal notranslate"><span class="pre">env</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LABEL</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.extra_labels" title="bci_build.package.BaseContainerImage.extra_labels"><code class="xref py py-attr docutils literal notranslate"><span class="pre">extra_labels</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAINTAINER</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.maintainer" title="bci_build.package.BaseContainerImage.maintainer"><code class="xref py py-attr docutils literal notranslate"><span class="pre">maintainer</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">USER</span></code>: <a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.entrypoint_user" title="bci_build.package.BaseContainerImage.entrypoint_user"><code class="xref py py-attr docutils literal notranslate"><span class="pre">entrypoint_user</span></code></a></p></li>
</ul>
<p>For additional settings that do not fit the existing attributes, either create
an abstraction (if feasible and meaningful) or use
<a class="reference internal" href="api.html#bci_build.package.BaseContainerImage.custom_end" title="bci_build.package.BaseContainerImage.custom_end"><code class="xref py py-attr docutils literal notranslate"><span class="pre">custom_end</span></code></a> to write a raw
<code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code> yourself.</p>
</section>
<section id="new-package-checklist">
<h2>New Package Checklist<a class="headerlink" href="#new-package-checklist" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>[ ] Merge the pull request creating the container into <code class="docutils literal notranslate"><span class="pre">main</span></code></p></li>
<li><p>[ ] Review the automatically created pull request against the deployment
branches and add a changelog entry</p></li>
<li><p>[ ] Create the package on <cite>devel:BCI:</cite> with a <cite>&lt;scmsync&gt;</cite> entry so that it is
pulled from git</p></li>
<li><p>[ ] Set up branch protection rules for the deployment branches including the
newly added package for the OBS SCM builds</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">bci-build-templates</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Adding and Modifying Container Images</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adding-files-to-the-image">Adding files to the Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automatic-package-version-substitution">Automatic Package Version Substitution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-packages-into-the-container-image">Installing Packages into the Container Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#applying-additional-changes-to-your-image">Applying additional changes to your Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#new-package-checklist">New Package Checklist</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="creating_packages.html">Creating packages on OBS</a></li>
<li class="toctree-l1"><a class="reference internal" href="staging_bot.html">Staging Bot</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">BCI build recipe generator</a></li>
      <li>Next: <a href="creating_packages.html" title="next chapter">Creating packages on OBS</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Dan Čermák.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/adding_containers.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Staging Bot &#8212; bci-build-templates  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Documentation" href="api.html" />
    <link rel="prev" title="Creating packages on OBS" href="creating_packages.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="staging-bot">
<h1>Staging Bot<a class="headerlink" href="#staging-bot" title="Permalink to this heading">¶</a></h1>
<p>Pull requests to the project are tested using a bot running via github
actions. It writes all build recipes for the images to a branch and creates a
staging project on <a class="reference external" href="https://build.opensuse.org/">https://build.opensuse.org/</a> under the user <code class="docutils literal notranslate"><span class="pre">defolos</span></code>
(private account of <a class="reference external" href="https://github.com/dcermak">Dan Čermák</a>). The bot will
then write a comment in the pull request for each OS version that had changes
with the branch name, the staging project URL and wait for the builds in the
staging project to finish. Once they have finished, it will update the comment
with the build results and either pass or fail the CI job depending on how the
containers built on OBS. The bot will delete the previously created staging
project and branches on each new push or when the PR is closed/merged.</p>
<p>For further details, see <a class="reference internal" href="api.html#staging.bot.StagingBot" title="staging.bot.StagingBot"><code class="xref py py-class docutils literal notranslate"><span class="pre">StagingBot</span></code></a> or refer to the
script <strong class="command">scratch-build-bot.py</strong>.</p>
<section id="branch-setup">
<h2>Branch setup<a class="headerlink" href="#branch-setup" title="Permalink to this heading">¶</a></h2>
<p>The source code of the generator and all utilities lives in the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch,
while the build recipes are written into separate, so called, deployment
branches in this repository. For openSUSE Tumbleweed that is the <a class="reference external" href="https://github.com/SUSE/BCI-dockerfile-generator/tree/tumbleweed">tumbleweed</a> branch and
for SLE these are <code class="docutils literal notranslate"><span class="pre">sle15-sp$SERVICE_PACK_NUMBER</span></code>. All of these branches are
protected on Github and only allow to be updated via pull requests.</p>
<p>The staging bot uses the deployment branches as a base to run test builds and
will create new branches with the name <code class="docutils literal notranslate"><span class="pre">$deployment_branch-$random_ASCII</span></code> for
pull requests against <code class="docutils literal notranslate"><span class="pre">main</span></code>. The bot will write the new build recipes once a
pull request for <code class="docutils literal notranslate"><span class="pre">main</span></code> has been merged into the branch
<code class="docutils literal notranslate"><span class="pre">for-deploy-$deployment_branch</span></code> and create a pull request against the
respective deployment branch. Here we leverage OBS’ <a class="reference external" href="https://openbuildservice.org/help/manuals/obs-user-guide/cha.obs.scm_ci_workflow_integration.html">SCM CI</a>
to branch the packages from the CR project
(<a class="reference internal" href="api.html#staging.bot.StagingBot.continuous_rebuild_project_name" title="staging.bot.StagingBot.continuous_rebuild_project_name"><code class="xref py py-attr docutils literal notranslate"><span class="pre">continuous_rebuild_project_name</span></code></a>) using the
<code class="file docutils literal notranslate"><span class="pre">.obs/workflows.yml</span></code> generated by the staging bot
(<a class="reference internal" href="api.html#staging.bot.StagingBot.obs_workflows_yml" title="staging.bot.StagingBot.obs_workflows_yml"><code class="xref py py-attr docutils literal notranslate"><span class="pre">obs_workflows_yml</span></code></a>).</p>
</section>
<section id="project-setup">
<h2>Project Setup<a class="headerlink" href="#project-setup" title="Permalink to this heading">¶</a></h2>
<p>The current CI setup includes the following projects:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">devel:BCI:${OS_VERSION}</span></code>: The final build recipes reside in this
project. Each package is created via <strong class="command">scratch-build-bot.py
setup_obs_package</strong> which sets up the package to <code class="docutils literal notranslate"><span class="pre">scmsync</span></code> the contents from
a subdirectory in the deployment branch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">home:defolos:CR:${OS_VERSION}</span></code>: A test project, which has a project wide
<code class="docutils literal notranslate"><span class="pre">scmsync</span></code> to the deployment branch. Therefore it will automatically pick up
every new package without manual intervention and it will also use the correct
<code class="docutils literal notranslate"><span class="pre">prjconf</span></code> via the <code class="file docutils literal notranslate"><span class="pre">_config</span></code> (this file is populated in
<a class="reference internal" href="api.html#staging.bot.StagingBot.write_all_image_build_recipes" title="staging.bot.StagingBot.write_all_image_build_recipes"><code class="xref py py-func docutils literal notranslate"><span class="pre">write_all_image_build_recipes()</span></code></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">home:defolos:Staging:${OS_VERSION}:${branch_name}-${random}</span></code>: The scratch
build project created for each pull request against <code class="docutils literal notranslate"><span class="pre">main</span></code> by the staging
bot in <a class="reference internal" href="api.html#staging.bot.StagingBot.scratch_build" title="staging.bot.StagingBot.scratch_build"><code class="xref py py-func docutils literal notranslate"><span class="pre">scratch_build()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">home:defolos:BCI:CR:${OS_VERSION}:Staging:SUSE:BCI-dockerfile-generator:PR-${PR_NUM}</span></code>:
projects created by OBS’ SCM CI from <code class="docutils literal notranslate"><span class="pre">home:defolos:CR:${OS_VERSION}</span></code> for
every pull request against the deployment branches.</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">bci-build-templates</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="adding_containers.html">Adding and Modifying Container Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="creating_packages.html">Creating packages on OBS</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Staging Bot</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#branch-setup">Branch setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#project-setup">Project Setup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="creating_packages.html" title="previous chapter">Creating packages on OBS</a></li>
      <li>Next: <a href="api.html" title="next chapter">API Documentation</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Dan Čermák.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/staging_bot.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>